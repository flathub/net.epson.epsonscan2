From c869fd6b9305a02b7054baae8ea4592fd3126de3 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Hubert=20Figui=C3=A8re?= <hub@figuiere.net>
Date: Sat, 1 Jun 2024 19:41:13 -0400
Subject: [PATCH 1/5] Fix prefix to flatpak
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Could be made more generic by honouring prefix

Flatpak specific

Signed-off-by: Hubert Figui√®re <hub@figuiere.net>
---
 CMakeLists.txt                                    | 6 +++---
 src/Controller/Src/Filter/GetOrientation.cpp      | 4 ++--
 src/ScanSDK/Src/SDK/SCANSDKsample_C++/EslStub.cpp | 8 ++++----
 src/Standalone/CMakeLists.txt                     | 2 +-
 4 files changed, 10 insertions(+), 10 deletions(-)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index a9daee7..7934a0e 100755
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -17,7 +17,7 @@
 #  CMakeLists.txt -- template and derived ESC/I ESC/I-2 protocol commands
 
 project (epsonscan2)
-set (CMAKE_INSTALL_PREFIX "/usr")
+#set (CMAKE_INSTALL_PREFIX "/usr")
 cmake_minimum_required (VERSION 2.8.12.2)
 
 include(GNUInstallDirs)
@@ -86,7 +86,7 @@ set(COMMON_ETC_PATH ${CMAKE_INSTALL_FULL_SYSCONFDIR})
 set(EPSON_WORK_PATH /tmp/epsonWork/)
 set(EPSON_SETTINGS_PATH $ENV{HOME}/.epsonscan2/)
 
-SET (CMAKE_INSTALL_PREFIX /usr)
+#SET (CMAKE_INSTALL_PREFIX /usr)
 set(EPSON_INSTALL_PATH ${CMAKE_INSTALL_FULL_LIBDIR}/epsonscan2/)
 set(COMMON_SHARE_PATH ${CMAKE_INSTALL_FULL_DATAROOTDIR})
 
@@ -113,7 +113,7 @@ add_subdirectory(src)
 
 install(DIRECTORY Resources DESTINATION ${EPSON_INSTALL_ROOT}${EPSON_INSTALL_PATH})
 
-install(FILES epsonscan2.rules DESTINATION ${EPSON_INSTALL_ROOT}/lib/udev/rules.d/ RENAME 60-epsonscan2.rules)
+#install(FILES epsonscan2.rules DESTINATION ${EPSON_INSTALL_ROOT}/lib/udev/rules.d/ RENAME 60-epsonscan2.rules)
 install(FILES epsonscan2 DESTINATION ${EPSON_INSTALL_ROOT}/etc/sane.d/dll.d)
 install(CODE "execute_process(COMMAND ${CMAKE_COMMAND} -E make_directory ${EPSON_INSTALL_ROOT}${CMAKE_INSTALL_FULL_LIBDIR}/sane/)")
 install(CODE "execute_process(COMMAND ${CMAKE_COMMAND} -E create_symlink ../epsonscan2/libsane-epsonscan2.so ${EPSON_INSTALL_ROOT}${CMAKE_INSTALL_FULL_LIBDIR}/sane/libsane-epsonscan2.so.1)")
diff --git a/src/Controller/Src/Filter/GetOrientation.cpp b/src/Controller/Src/Filter/GetOrientation.cpp
index 387561e..6aa8f25 100644
--- a/src/Controller/Src/Filter/GetOrientation.cpp
+++ b/src/Controller/Src/Filter/GetOrientation.cpp
@@ -13,12 +13,12 @@ namespace epsonscan
 static std::string GetExecPath()
 {
 #ifdef AKBMODE
-    std::string strDst = "/usr/libexec/";
+    std::string strDst = "/app/libexec/";
     strDst = strDst + DRIVER_NAME;
     strDst = strDst + "-ocr/ocr-engine-getrotate";
     return strDst.c_str() ;
 #else
-    return "/usr/libexec/epsonscan2-ocr/ocr-engine-getrotate" ;
+    return "/app/libexec/epsonscan2-ocr/ocr-engine-getrotate" ;
 #endif
 }
 static const int kMaxBuf = 256;
diff --git a/src/ScanSDK/Src/SDK/SCANSDKsample_C++/EslStub.cpp b/src/ScanSDK/Src/SDK/SCANSDKsample_C++/EslStub.cpp
index 9c5bfda..16b0a61 100644
--- a/src/ScanSDK/Src/SDK/SCANSDKsample_C++/EslStub.cpp
+++ b/src/ScanSDK/Src/SDK/SCANSDKsample_C++/EslStub.cpp
@@ -10,10 +10,10 @@
 #include <iostream>
 
 //SDK library input full path
-#define	SCANSDK_DLL_X86_64	    "/usr/lib/x86_64-linux-gnu/epsonscan2/libepsonscansdk.so"
-#define	SCANSDK_DLL_ARM	        "/usr/lib/aarch64-linux-gnu/epsonscan2/libepsonscansdk.so"
-#define	SCANSDK_DLL_MIPS	        "/usr/lib/mips64el-linux-gnuabi64/epsonscan2/libepsonscansdk.so"
-#define	SCANSDK_DLL_LOONGARCH    "/usr/lib/loongarch64-linux-gnu/epsonscan2/libepsonscansdk.so"
+#define	SCANSDK_DLL_X86_64	    "/app/lib/x86_64-linux-gnu/epsonscan2/libepsonscansdk.so"
+#define	SCANSDK_DLL_ARM	        "/app/lib/aarch64-linux-gnu/epsonscan2/libepsonscansdk.so"
+#define	SCANSDK_DLL_MIPS	        "/app/lib/mips64el-linux-gnuabi64/epsonscan2/libepsonscansdk.so"
+#define	SCANSDK_DLL_LOONGARCH    "/app/lib/loongarch64-linux-gnu/epsonscan2/libepsonscansdk.so"
 
 
 CEslStub::CEslStub(LPCTSTR pszLibModule) :
diff --git a/src/Standalone/CMakeLists.txt b/src/Standalone/CMakeLists.txt
index eff3dd3..444dafd 100644
--- a/src/Standalone/CMakeLists.txt
+++ b/src/Standalone/CMakeLists.txt
@@ -167,5 +167,5 @@ target_link_libraries(es2standalone ${QT_LIBRARIES}
 )
 
 QT5_USE_MODULES(es2standalone Widgets)
-install(TARGETS es2standalone DESTINATION "${EPSON_INSTALL_ROOT}/usr/bin")
+install(TARGETS es2standalone DESTINATION "${EPSON_INSTALL_ROOT}${CMAKE_INSTALL_PREFIX}/bin")
 
-- 
2.51.0

